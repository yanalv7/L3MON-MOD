<div class="ui segment">
    <div class="ui secondary menu">
        <div class="right menu">
            <button onclick="openDirectory(this, '/storage/emulated/0')" class="ui blue button dlop"> 
                <i class="icon home"></i>Home
            </button>
        </div>
    </div>
    <table class="ui celled table">
        <thead>
            <tr>
                <th style="text-align: center" colspan="3">Files</th>
            </tr>
        </thead>
        <tbody id="fileTableBody">
            <!-- سيتم ملء هذا الجدول ديناميكيًا -->
        </tbody>
    </table>

    <script>
        // وظيفة لفتح الدليل وتحديث الجدول
        function openDirectory(element, path) {
            console.log("Requesting directory:", path);
            $.ajax({
                url: '/api/openDirectory',
                type: 'POST',
                data: JSON.stringify({ path: path }),
                contentType: 'application/json',
                success: (response) => {
                    console.log("Response received:", response);
                    updateFileTable(response.data);
                },
                error: (xhr, status, error) => {
                    console.error("Error:", error);
                    showNotification('#f03434', 'فشل في فتح الدليل.');
                }
            });
        }

        // وظيفة لتحديث الجدول بالبيانات الجديدة
        function updateFileTable(data) {
            console.log("Updating file table with data:", data);
            const fileTableBody = document.getElementById('fileTableBody');
            fileTableBody.innerHTML = '';

            if (data.length === 0) {
                fileTableBody.innerHTML = '<tr><td colspan="3" style="text-align: center;">لا توجد ملفات لعرضها</td></tr>';
            } else {
                data.forEach((item) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td title="${item.path}">${item.name}</td>
                        <td class="collapsing">
                            ${!item.isDir ? `
                                <button class="ui button dlop" onclick="downloadFile(this, '${item.path}')">
                                    &nbsp;&nbsp;&nbsp;<i class="icon download blue"></i>
                                </button>
                                <button class="ui button red" onclick="deleteFile(this, '${item.path}')">
                                    &nbsp;&nbsp;&nbsp;<i class="icon trash"></i>
                                </button>
                            ` : `
                                <button class="ui button dlop" onclick="openDirectory(this, '${item.path}')">
                                    &nbsp;&nbsp;&nbsp;<i class="icon folder open grey"></i>
                                </button>
                            `}
                        </td>
                    `;
                    fileTableBody.appendChild(row);
                });
            }
        }

        // وظيفة لحذف ملف
        function deleteFile(element, path) {
            const confirmation = confirm("هل أنت متأكد أنك تريد حذف هذا الملف؟");
            if (!confirmation) return;

            $(element).children().css("opacity", "0");
            $(element).addClass('red');
            $(element).addClass('loading');
            $('.dlop').addClass('disabled');

            sendCommand('0xFI', {
                action: 'rm',
                path
            }, (error, message) => {
                if (error) {
                    setTimeout(() => {
                        showNotification('#f03434', error);
                        $(element).children().css("opacity", "1");
                        $(element).removeClass('red');
                        $('.dlop').removeClass('disabled');
                    }, 300);
                } else {
                    setTimeout(() => {
                        $(element).closest('tr').remove(); // إزالة الصف من الجدول
                        showNotification('#2ecc71', 'تم حذف الملف بنجاح.');
                        $(element).children().css("opacity", "1");
                        $(element).removeClass('red');
                        $('.dlop').removeClass('disabled');
                    }, 300);
                }
            });
        }

        // وظيفة لإرسال الأوامر إلى الخادم
        function sendCommand(command, data, callback) {
            $.ajax({
                url: '/api/delete',
                type: 'POST',
                data: JSON.stringify(data),
                contentType: 'application/json',
                success: (response) => {
                    callback(null, response.status);
                },
                error: (xhr, status, error) => {
                    callback(error, null);
                }
            });
        }

        // وظيفة لعرض الإشعارات
        function showNotification(color, message) {
            console.log(`%c${message}`, `color: ${color}`);
            // يمكنك استخدام مكتبة مثل toastr أو SweetAlert لعرض إشعارات مرئية
        }

        // تحميل الملفات عند تحميل الصفحة لأول مرة
        $(document).ready(function() {
            openDirectory(null, '/storage/emulated/0'); // تحميل الملفات من الدليل الرئيسي عند بدء التشغيل
        });
    </script>
</div>
